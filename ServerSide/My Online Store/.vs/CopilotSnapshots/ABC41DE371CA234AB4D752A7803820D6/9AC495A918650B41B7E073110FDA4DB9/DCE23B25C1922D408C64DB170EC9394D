# Online Store API - Implementation Summary & JWT Tutorial

## ? **COMPLETED ENDPOINTS**

### Authentication Endpoints (JWT Implemented) ?
- **POST /api/auth/login** - Login with username and password
- **POST /api/auth/register** - Register a new customer account
- **GET /api/auth/me** - Get current authenticated user (requires JWT token)

### Products Endpoints ?
- **GET /api/products** - Get all products with images and category info
- **GET /api/products/{id}** - Get single product with full details
- **GET /api/products/category/{categoryId}** - Get products by category
- **GET /api/products/search?q=query** - Search products by name or description

### Categories Endpoints ?
- **GET /api/categories** - Get all categories

### Reviews Endpoints ?
- **GET /api/products/{productId}/reviews** - Get all reviews for a product
- **POST /api/reviews** - Create a new review (requires authentication)

### Customers Endpoints ?
- **PUT /api/customers/{id}** - Update customer profile (authentication recommended but not enforced yet)

---

## ? **MISSING/INCOMPLETE ENDPOINTS**

### Order Endpoints (PARTIALLY MISSING)
- ? **POST /api/orders** - Basic endpoint exists but needs complex structure for items, shipping, payment
- ? **GET /api/customers/{customerId}/orders** - Get all orders for a customer
- ? **GET /api/orders/{id}** - Get order with full details (items, shipping, payment)
- ? **PUT /api/orders/{id}/cancel** - Cancel an order
- ? **GET /api/orders/{id}/tracking** - Get tracking information

---

## ?? **JWT AUTHENTICATION - HOW IT WORKS**

### What is JWT?
JWT (JSON Web Token) is a secure way to transmit information between parties as a JSON object. It's commonly used for authentication in APIs.

### JWT Structure
A JWT has three parts separated by dots (.):
```
header.payload.signature
```

Example:
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

### How JWT Works in Your API

#### 1. **User Login Flow**
```
1. User sends username & password to POST /api/auth/login
2. Server validates credentials
3. Server generates JWT token using JwtService
4. Server returns token + user data
5. Client stores token (localStorage/cookie)
```

#### 2. **Making Authenticated Requests**
```
1. Client includes token in Authorization header
2. Format: Authorization: Bearer <token>
3. Server validates token automatically
4. If valid, request proceeds; if not, returns 401 Unauthorized
```

### JWT Configuration in Your Project

**appsettings.json:**
```json
{
  "Jwt": {
    "Key": "YourSuperSecretKeyThatIsAtLeast32CharactersLong!!!",
    "Issuer": "OnlineStoreAPI",
    "Audience": "OnlineStoreClient"
  }
}
```

- **Key**: Secret key used to sign tokens (MUST be kept secret!)
- **Issuer**: Who created the token (your API)
- **Audience**: Who can use the token (your frontend)

### JWT Service (Services/JwtService.cs)
```csharp
public string GenerateToken(int customerId, string username)
{
    // Claims = data stored in the token
    var claims = new[]
    {
        new Claim(ClaimTypes.NameIdentifier, customerId.ToString()),
        new Claim(ClaimTypes.Name, username),
        new Claim(JwtRegisteredClaimNames.Jti, Guid.NewGuid().ToString())
    };

    // Token expires in 7 days
    expires: DateTime.UtcNow.AddDays(7)
}
```

### Using JWT in Controllers

**Mark endpoint as requiring authentication:**
```csharp
[Authorize]
[HttpGet("me")]
public ActionResult<CustomerDTO> GetCurrentUser()
{
    // Get user ID from JWT claims
    var customerIdClaim = User.FindFirst(ClaimTypes.NameIdentifier);
    int customerId = int.Parse(customerIdClaim.Value);
    
    // Use customerId to fetch user data
}
```

### Testing JWT in Postman/Frontend

**1. Login to get token:**
```
POST http://localhost:5000/api/auth/login
Content-Type: application/json

{
  "username": "john_doe",
  "password": "password123"
}

Response:
{
  "customer": { ... },
  "token": "eyJhbGciOiJIUzI1NiIs..."
}
```

**2. Use token in protected endpoints:**
```
GET http://localhost:5000/api/auth/me
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

---

## ?? **REQUIRED DATABASE STORED PROCEDURES**

You need to create these stored procedures in your database:

### Customer Authentication
```sql
-- Get customer by username (for login)
CREATE PROCEDURE SP_GetCustomerByUsername
    @Username NVARCHAR(100)
AS
BEGIN
    SELECT * FROM Customers WHERE Username = @Username
END
```

### Product Queries
```sql
-- Get products by category
CREATE PROCEDURE SP_GetProductsByCategoryID
    @CategoryID INT
AS
BEGIN
    SELECT * FROM ProductCatalog WHERE CategoryID = @CategoryID
END

-- Search products
CREATE PROCEDURE SP_SearchProducts
    @SearchTerm NVARCHAR(200)
AS
BEGIN
    SELECT * FROM ProductCatalog 
    WHERE ProductName LIKE '%' + @SearchTerm + '%' 
       OR Description LIKE '%' + @SearchTerm + '%'
END
```

### Image Queries
```sql
-- Get images by product ID
CREATE PROCEDURE SP_GetImagesByProductID
    @ProductID INT
AS
BEGIN
    SELECT * FROM ProductImages 
    WHERE ProductID = @ProductID 
    ORDER BY ImageOrder
END
```

### Review Queries
```sql
-- Get reviews by product ID
CREATE PROCEDURE SP_GetReviewsByProductID
    @ProductID INT
AS
BEGIN
    SELECT * FROM Reviews WHERE ProductID = @ProductID
END
```

---

## ?? **QUICK START GUIDE**

### 1. Update appsettings.json
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "YOUR_CONNECTION_STRING"
  },
  "Jwt": {
    "Key": "YourSuperSecretKeyThatIsAtLeast32CharactersLong!!!",
    "Issuer": "OnlineStoreAPI",
    "Audience": "OnlineStoreClient"
  }
}
```

### 2. Create Database Stored Procedures
Run the SQL scripts above in your database.

### 3. Run the API
```bash
dotnet run
```

### 4. Test Authentication
```bash
# Register new user
POST http://localhost:5000/api/auth/register
{
  "name": "John Doe",
  "email": "john@example.com",
  "username": "johndoe",
  "password": "password123",
  "phone": "+1234567890",
  "address": "123 Main St"
}

# Login
POST http://localhost:5000/api/auth/login
{
  "username": "johndoe",
  "password": "password123"
}

# Use token from login response
GET http://localhost:5000/api/auth/me
Authorization: Bearer <token_from_login>
```

---

## ?? **TODO: Complete Missing Endpoints**

To fully match the frontend documentation, you need to implement:

### 1. Order Management
- Create DTOs for complex order structure (OrderItems, Shipping, Payment)
- Implement GET /api/customers/{customerId}/orders
- Implement GET /api/orders/{id} with full details
- Implement PUT /api/orders/{id}/cancel
- Implement GET /api/orders/{id}/tracking

### 2. Add Authentication to More Endpoints
Add `[Authorize]` attribute to endpoints that should require authentication:
- Customer update endpoint
- Order creation/viewing
- Review creation

### 3. Add Database Stored Procedures
Create all missing stored procedures listed above.

---

## ?? **LEARNING JWT - KEY CONCEPTS**

### 1. **Stateless Authentication**
- Server doesn't store session data
- Token contains all needed information
- Scales better than session-based auth

### 2. **Token Expiration**
- Tokens have expiration time (7 days in your config)
- Frontend should handle token refresh
- Expired tokens return 401 Unauthorized

### 3. **Claims**
- Claims = data stored in token
- Common claims:
  - `NameIdentifier` = User ID
  - `Name` = Username
  - `Email` = User email
  - Custom claims for roles, permissions, etc.

### 4. **Security Best Practices**
- ? Keep secret key secure (environment variables in production)
- ? Use HTTPS in production
- ? Implement token refresh mechanism
- ? Validate token on every request
- ? Set reasonable expiration times
- ? Never store sensitive data in tokens (they're not encrypted!)

---

## ?? **CORS Configuration**

Your API is configured to allow all origins (for development):
```csharp
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", builder =>
    {
        builder.AllowAnyOrigin()
               .AllowAnyMethod()
               .AllowAnyHeader();
    });
});
```

**For production**, restrict to specific origins:
```csharp
builder.AllowOrigins("https://yourdomain.com")
```

---

## ?? **NuGet Packages Installed**

- ? Microsoft.AspNetCore.Authentication.JwtBearer (9.0.10)
- ? System.IdentityModel.Tokens.Jwt (8.14.0)
- ? Microsoft.AspNetCore.OpenApi (9.0.10)

---

## ?? **SUMMARY**

### What You Have:
- ? Complete JWT authentication system
- ? Login/Register/Get Current User endpoints
- ? Product endpoints with images and categories
- ? Review endpoints
- ? CORS enabled for frontend integration

### What You Need:
- ? Complex order endpoints
- ? Database stored procedures
- ? Add [Authorize] to more endpoints
- ? Order tracking functionality

### Next Steps:
1. Create all database stored procedures
2. Test authentication flow
3. Implement remaining order endpoints
4. Add proper error handling
5. Test with frontend application

---

**Good luck with your online store project! ??**
