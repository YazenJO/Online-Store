-- =====================================================
-- OrderItems Table and Stored Procedures
-- =====================================================
-- This script creates the complete OrderItems functionality

-- =====================================================
-- STEP 1: Drop existing table if needed (for clean recreation)
-- =====================================================

-- Drop table if it exists to recreate with correct structure
IF EXISTS (SELECT * FROM sys.tables WHERE name = 'OrderItems')
BEGIN
    DROP TABLE OrderItems;
    PRINT 'Existing OrderItems table dropped.';
END
GO

-- =====================================================
-- STEP 2: Create OrderItems Table with Composite Primary Key
-- =====================================================

CREATE TABLE OrderItems (
    OrderID INT NOT NULL,
    ProductID INT NOT NULL,
    Quantity INT NOT NULL CHECK (Quantity > 0),
    Price DECIMAL(10, 2) NOT NULL CHECK (Price >= 0),
    TotalItemsPrice DECIMAL(10, 2) NOT NULL CHECK (TotalItemsPrice >= 0),
    
    -- Composite Primary Key: OrderID + ProductID
    CONSTRAINT PK_OrderItems PRIMARY KEY (OrderID, ProductID),
    
    -- Foreign Keys
    CONSTRAINT FK_OrderItems_Orders FOREIGN KEY (OrderID) REFERENCES Orders(OrderID) ON DELETE CASCADE,
    CONSTRAINT FK_OrderItems_Products FOREIGN KEY (ProductID) REFERENCES Products(ProductID)
);
PRINT 'OrderItems table created successfully with composite primary key (OrderID, ProductID)!';
GO

-- =====================================================
-- STEP 3: Stored Procedures
-- =====================================================

-- SP_AddOrderItem: Add a new order item
CREATE OR ALTER PROCEDURE SP_AddOrderItem
    @OrderID INT,
    @ProductID INT,
    @Quantity INT,
    @Price DECIMAL(10, 2),
    @TotalItemsPrice DECIMAL(10, 2)
AS
BEGIN
    INSERT INTO OrderItems (OrderID, ProductID, Quantity, Price, TotalItemsPrice)
    VALUES (@OrderID, @ProductID, @Quantity, @Price, @TotalItemsPrice);
    
    -- Return success (1) or failure (0)
    SELECT 1 AS Success;
END;
GO

-- SP_GetOrderItemByID: Get a single order item by composite key
CREATE OR ALTER PROCEDURE SP_GetOrderItemByID
    @OrderID INT,
    @ProductID INT
AS
BEGIN
    SELECT OrderID, ProductID, Quantity, Price, TotalItemsPrice
    FROM OrderItems
    WHERE OrderID = @OrderID AND ProductID = @ProductID;
END;
GO

-- SP_GetOrderItemsByOrderID: Get all items for a specific order
CREATE OR ALTER PROCEDURE SP_GetOrderItemsByOrderID
    @OrderID INT
AS
BEGIN
    SELECT 
        oi.OrderID,
        oi.ProductID,
        p.ProductName,
        oi.Quantity,
        oi.Price,
        oi.TotalItemsPrice
    FROM OrderItems oi
    INNER JOIN Products p ON oi.ProductID = p.ProductID
    WHERE oi.OrderID = @OrderID
    ORDER BY oi.ProductID;
END;
GO

-- SP_UpdateOrderItem: Update an order item
CREATE OR ALTER PROCEDURE SP_UpdateOrderItem
    @OrderID INT,
    @ProductID INT,
    @Quantity INT,
    @Price DECIMAL(10, 2),
    @TotalItemsPrice DECIMAL(10, 2)
AS
BEGIN
    UPDATE OrderItems
    SET Quantity = @Quantity,
        Price = @Price,
        TotalItemsPrice = @TotalItemsPrice
    WHERE OrderID = @OrderID AND ProductID = @ProductID;
    
    SELECT @@ROWCOUNT;
END;
GO

-- SP_DeleteOrderItem: Delete a single order item
CREATE OR ALTER PROCEDURE SP_DeleteOrderItem
    @OrderID INT,
    @ProductID INT
AS
BEGIN
    DELETE FROM OrderItems
    WHERE OrderID = @OrderID AND ProductID = @ProductID;
    
    SELECT @@ROWCOUNT;
END;
GO

-- SP_DeleteOrderItemsByOrderID: Delete all items for an order (used in rollback)
CREATE OR ALTER PROCEDURE SP_DeleteOrderItemsByOrderID
    @OrderID INT
AS
BEGIN
    DELETE FROM OrderItems
    WHERE OrderID = @OrderID;
    
    SELECT @@ROWCOUNT;
END;
GO

-- SP_DoesOrderItemExist: Check if an order item exists
CREATE OR ALTER PROCEDURE SP_DoesOrderItemExist
    @OrderID INT,
    @ProductID INT
AS
BEGIN
    IF EXISTS (SELECT 1 FROM OrderItems WHERE OrderID = @OrderID AND ProductID = @ProductID)
        SELECT CAST(1 AS BIT) AS Result;
    ELSE
        SELECT CAST(0 AS BIT) AS Result;
END;
GO

-- SP_GetAllOrderItems: Get all order items (admin)
CREATE OR ALTER PROCEDURE SP_GetAllOrderItems
AS
BEGIN
    SELECT 
        oi.OrderID,
        oi.ProductID,
        p.ProductName,
        oi.Quantity,
        oi.Price,
        oi.TotalItemsPrice
    FROM OrderItems oi
    INNER JOIN Products p ON oi.ProductID = p.ProductID
    ORDER BY oi.OrderID DESC, oi.ProductID;
END;
GO

-- =====================================================
-- STEP 4: Helper Procedure to Update Product Stock
-- =====================================================

CREATE OR ALTER PROCEDURE SP_UpdateProductStock
    @ProductID INT,
    @QuantityChange INT  -- Negative to reduce, positive to increase
AS
BEGIN
    UPDATE Products
    SET QuantityInStock = QuantityInStock + @QuantityChange
    WHERE ProductID = @ProductID;
    
    -- Return the new stock level
    SELECT QuantityInStock
    FROM Products
    WHERE ProductID = @ProductID;
END;
GO

-- =====================================================
-- STEP 5: Verification Queries
-- =====================================================

-- Check if OrderItems table exists and show structure
SELECT 
    COLUMN_NAME, 
    DATA_TYPE, 
    IS_NULLABLE, 
    COLUMN_DEFAULT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'OrderItems'
ORDER BY ORDINAL_POSITION;
GO

-- Show primary key constraint
SELECT 
    tc.CONSTRAINT_NAME,
    tc.CONSTRAINT_TYPE,
    kcu.COLUMN_NAME
FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS tc
INNER JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE kcu 
    ON tc.CONSTRAINT_NAME = kcu.CONSTRAINT_NAME
WHERE tc.TABLE_NAME = 'OrderItems'
ORDER BY kcu.ORDINAL_POSITION;
GO

-- List all created stored procedures
SELECT 
    ROUTINE_NAME,
    ROUTINE_TYPE,
    CREATED,
    LAST_ALTERED
FROM INFORMATION_SCHEMA.ROUTINES
WHERE ROUTINE_NAME LIKE 'SP_%OrderItem%'
   OR ROUTINE_NAME = 'SP_UpdateProductStock'
ORDER BY ROUTINE_NAME;
GO

PRINT '=======================================================';
PRINT 'OrderItems table and stored procedures created successfully!';
PRINT '=======================================================';
PRINT '';
PRINT 'Table Structure:';
PRINT '  - Composite Primary Key: (OrderID, ProductID)';
PRINT '  - Foreign Keys: OrderID → Orders, ProductID → Products';
PRINT '';
PRINT 'Created Stored Procedures:';
PRINT '1. SP_AddOrderItem';
PRINT '2. SP_GetOrderItemByID (requires OrderID + ProductID)';
PRINT '3. SP_GetOrderItemsByOrderID';
PRINT '4. SP_UpdateOrderItem';
PRINT '5. SP_DeleteOrderItem (requires OrderID + ProductID)';
PRINT '6. SP_DeleteOrderItemsByOrderID';
PRINT '7. SP_DoesOrderItemExist (requires OrderID + ProductID)';
PRINT '8. SP_GetAllOrderItems';
PRINT '9. SP_UpdateProductStock';
PRINT '';
PRINT 'Note: OrderItemID removed - using composite key (OrderID, ProductID)';
GO
